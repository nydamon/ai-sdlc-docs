#!/bin/bash

# Pre-push hook for AI-SDLC Framework
# Prevents pushing problematic code to remote repository

echo "ğŸ” Running pre-push validations..."

# Get current branch
protected_branch='main'
current_branch=$(git symbolic-ref HEAD | sed -e 's,.*/\(.*\),\1,')

# Prevent direct push to main branch
if [ $protected_branch = $current_branch ]; then
    echo "âŒ Direct push to main branch is not allowed"
    echo "ğŸ’¡ Create a pull request instead"
    exit 1
fi

# Check for merge conflicts
if ! git diff --check --cached >/dev/null 2>&1; then
    echo "âŒ Merge conflict markers found"
    echo "ğŸ’¡ Resolve conflicts before pushing"
    exit 1
fi

# Run fast tests (unit tests only, skip E2E)
echo "ğŸ§ª Running fast test suite..."
npm run ci:test-fast
if [ $? -ne 0 ]; then
    echo "âŒ Tests failed"
    echo "ğŸ’¡ Fix failing tests before pushing"
    echo "â„¹ï¸ E2E tests are run separately with Playwright"
    exit 1
fi

# FCRA Compliance Check
echo "ğŸ¦ Checking FCRA compliance patterns..."
if [ -f "scripts-complex/security-scanner.js" ]; then
    node scripts-complex/security-scanner.js quick
    if [ $? -ne 0 ]; then
        echo "âŒ FCRA compliance issues found"
        echo "ğŸ’¡ Review security scanner output"
        exit 1
    fi
fi

# Check for sensitive data
echo "ğŸ” Scanning for sensitive data..."
if command -v git-secrets >/dev/null 2>&1; then
    git secrets --scan
    if [ $? -ne 0 ]; then
        echo "âŒ Sensitive data detected"
        echo "ğŸ’¡ Remove secrets before pushing"
        exit 1
    fi
fi

echo "âœ… All pre-push validations passed"
exit 0